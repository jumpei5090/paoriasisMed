<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªç¿»è¨³ - PsoriasisMed</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">PsoriasisMed</div>
            <nav>
                <ul>
                    <li><a href="index.html#hero">ãƒ›ãƒ¼ãƒ </a></li>
                    <li><a href="index.html#categories">æ²»ç™‚è–¬</a></li>
                    <li><a href="index.html#comparison">è–¬å‰¤æ¯”è¼ƒ</a></li>
                    <li><a href="index.html#search-by-condition">ç—‡çŠ¶ç¢ºèªè¡¨</a></li>
                    <li><a href="index.html#about">ã‚µã‚¤ãƒˆã«ã¤ã„ã¦</a></li>
                </ul>
            </nav>
            <div class="utility-nav">
                <a href="search.html" class="search-icon">æ¤œç´¢</a>
                <a href="favorites.html" class="favorite-icon">ãŠæ°—ã«å…¥ã‚Š</a>
            </div>
        </div>
    </header>

    <main>
        <section class="translation-viewer-section">
            <div class="container">
                <div class="translation-header">
                    <div class="breadcrumb">
                        <a href="research_papers.html">â† åŒ»å­¦è«–æ–‡æƒ…å ±ã«æˆ»ã‚‹</a>
                    </div>
                    <h1 id="translation-title">æ—¥æœ¬èªç¿»è¨³</h1>
                    <div class="translation-meta">
                        <span class="translation-badge">æ—¥æœ¬èªç¿»è¨³</span>
                        <span class="translation-note">â€»æ©Ÿæ¢°ç¿»è¨³ã«ã‚ˆã‚‹å‚è€ƒè¨³ã§ã™</span>
                    </div>
                </div>

                <div class="translation-content">
                    <div class="translation-paper" id="translation-content">
                        <div class="loading-message">
                            <div class="loading-icon">ğŸ“„</div>
                            <p>ç¿»è¨³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                        </div>
                    </div>
                </div>

                <div class="translation-actions">
                    <button class="button secondary" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
                    <button class="button secondary" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <a href="research_papers.html" class="button primary">è«–æ–‡ä¸€è¦§ã«æˆ»ã‚‹</a>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-columns">
                <div class="footer-logo">PsoriasisMed</div>
                <div class="footer-nav">
                    <h4>æ²»ç™‚è–¬</h4>
                    <ul>
                        <li><a href="biological_agents.html">ç”Ÿç‰©å­¦çš„è£½å‰¤</a></li>
                        <li><a href="oral_medications.html">å†…æœè–¬</a></li>
                        <li><a href="topical_medications.html">å¤–ç”¨è–¬</a></li>
                    </ul>
                </div>
                <div class="footer-nav">
                    <h4>æƒ…å ±</h4>
                    <ul>
                        <li><a href="search.html">è–¬å‰¤æ¤œç´¢</a></li>
                        <li><a href="index.html#comparison">æ¯”è¼ƒæ©Ÿèƒ½</a></li>
                        <li><a href="patient_symptom_checklist.html">æ‚£è€…ç—‡çŠ¶ç¢ºèªè¡¨</a></li>
                        <li><a href="research_papers.html">åŒ»å­¦è«–æ–‡æƒ…å ±</a></li>
                        <li><a href="how_to_use.html">ä½¿ã„æ–¹</a></li>
                        <li><a href="index.html#about">ã‚µã‚¤ãƒˆæƒ…å ±</a></li>
                        <li><a href="privacy_policy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
                        <li><a href="terms_of_service.html">åˆ©ç”¨è¦ç´„</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>Â© 2024 PsoriasisMed. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="research_papers_data.js"></script>
    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
        function getTranslationFileName() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('file');
        }

        // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        function loadTranslation() {
            const fileName = getTranslationFileName();
            if (!fileName) {
                showError('ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            // å¯¾å¿œã™ã‚‹è«–æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const paper = researchPapersData.find(p => 
                p.translation_url.includes(fileName)
            );

            if (paper) {
                document.getElementById('translation-title').textContent = 
                    `${paper.title} - æ—¥æœ¬èªç¿»è¨³`;
                document.title = `${paper.title} - æ—¥æœ¬èªç¿»è¨³ - PsoriasisMed`;
            }

            // ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            fetch(`research_papers/translations/${fileName}.txt`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (HTTP ${response.status})`);
                    }
                    return response.text();
                })
                .then(text => {
                    displayTranslation(text);
                })
                .catch(error => {
                    console.error('ç¿»è¨³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showError(`ç¿»è¨³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                });
        }

        // ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼å¯¾å¿œï¼‰
        function displayTranslation(text) {
            const content = document.getElementById('translation-content');
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›
            const html = convertMarkdownToHtml(text);
            content.innerHTML = html;
        }

        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’HTMLã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function convertMarkdownToHtml(text) {
            let html = text;
            
            // è¡Œã«åˆ†å‰²
            const lines = html.split('\n');
            let processedLines = [];
            let inTable = false;
            let tableRows = [];
            let inList = false;
            let listItems = [];
            let currentListType = '';
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // ç©ºè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (!line.trim()) {
                    // ãƒªã‚¹ãƒˆãŒçµ‚äº†
                    if (inList) {
                        processedLines.push(closeList(listItems, currentListType));
                        inList = false;
                        listItems = [];
                        currentListType = '';
                    }
                    processedLines.push('');
                    continue;
                }
                
                // è¦‹å‡ºã—ã®å‡¦ç†
                if (line.match(/^#{1,6}\s/)) {
                    // ãƒªã‚¹ãƒˆãŒçµ‚äº†
                    if (inList) {
                        processedLines.push(closeList(listItems, currentListType));
                        inList = false;
                        listItems = [];
                        currentListType = '';
                    }
                    
                    const headerLevel = (line.match(/^#+/) || [''])[0].length;
                    const headerText = line.replace(/^#+\s*/, '').replace(/\*+$/, '');
                    processedLines.push(`<h${Math.min(headerLevel + 1, 6)}>${headerText}</h${Math.min(headerLevel + 1, 6)}>`);
                    continue;
                }
                
                // æ°´å¹³ç·šã®å‡¦ç†
                if (line.match(/^---+$/)) {
                    processedLines.push('<hr>');
                    continue;
                }
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‡¦ç†
                if (line.match(/^\|.*\|$/)) {
                    if (!inTable) {
                        inTable = true;
                        tableRows = [];
                        processedLines.push('<table class="translation-table">');
                    }
                    
                    const cells = line.split('|').map(cell => cell.trim()).filter((cell, index, arr) => index !== 0 && index !== arr.length - 1);
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®åˆ¤å®š
                    if (cells.every(cell => cell.match(/^:?-+:?$/))) {
                        // ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                        continue;
                    }
                    
                    const isHeaderRow = i === 0 || (i > 0 && lines[i + 1] && lines[i + 1].match(/^\|.*:?-+:?.*\|$/));
                    const cellTag = isHeaderRow ? 'th' : 'td';
                    
                    const rowHtml = '<tr>' + cells.map(cell => `<${cellTag}>${formatInlineElements(cell)}</${cellTag}>`).join('') + '</tr>';
                    processedLines.push(rowHtml);
                    continue;
                } else if (inTable) {
                    // ãƒ†ãƒ¼ãƒ–ãƒ«çµ‚äº†
                    processedLines.push('</table>');
                    inTable = false;
                }
                
                // ãƒªã‚¹ãƒˆã®å‡¦ç†
                const bulletMatch = line.match(/^(\s*)[*+-]\s+(.+)$/);
                const numberedMatch = line.match(/^(\s*)\d+\.\s+(.+)$/);
                
                if (bulletMatch || numberedMatch) {
                    const isNumbered = !!numberedMatch;
                    const content = (bulletMatch || numberedMatch)[2];
                    const indent = (bulletMatch || numberedMatch)[1].length;
                    
                    if (!inList || currentListType !== (isNumbered ? 'ol' : 'ul')) {
                        if (inList) {
                            processedLines.push(closeList(listItems, currentListType));
                        }
                        inList = true;
                        currentListType = isNumbered ? 'ol' : 'ul';
                        listItems = [];
                    }
                    
                    listItems.push({
                        content: formatInlineElements(content),
                        indent: indent
                    });
                    continue;
                } else if (inList) {
                    // ãƒªã‚¹ãƒˆçµ‚äº†
                    processedLines.push(closeList(listItems, currentListType));
                    inList = false;
                    listItems = [];
                    currentListType = '';
                }
                
                // å¼•ç”¨ã®å‡¦ç†
                if (line.match(/^>\s/)) {
                    const quoteText = line.replace(/^>\s*/, '');
                    processedLines.push(`<blockquote>${formatInlineElements(quoteText)}</blockquote>`);
                    continue;
                }
                
                // é€šå¸¸ã®æ®µè½
                if (line.trim()) {
                    processedLines.push(`<p>${formatInlineElements(line)}</p>`);
                }
            }
            
            // æœ€å¾Œã«ãƒªã‚¹ãƒˆãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
            if (inList) {
                processedLines.push(closeList(listItems, currentListType));
            }
            
            // æœ€å¾Œã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
            if (inTable) {
                processedLines.push('</table>');
            }
            
            return processedLines.join('\n');
        }
        
        // ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã‚‹é–¢æ•°
        function closeList(listItems, listType) {
            if (listItems.length === 0) return '';
            
            let html = `<${listType}>`;
            listItems.forEach(item => {
                html += `<li>${item.content}</li>`;
            });
            html += `</${listType}>`;
            return html;
        }
        
        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¦ç´ ã®å‡¦ç†
        function formatInlineElements(text) {
            // å¼•ç”¨ã‚¿ã‚°ã®å‡¦ç† [cite: xxx] -> å¼•ç”¨ãƒªãƒ³ã‚¯
            text = text.replace(/\[cite:\s*(\d+)\]/g, '<sup class="citation"><a href="#ref-$1" title="å¼•ç”¨ $1">[$1]</a></sup>');
            text = text.replace(/\[cite_start\]/g, '');
            
            // å¤ªå­—ã®å‡¦ç†
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // æ–œä½“ã®å‡¦ç†
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã®å‡¦ç†
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // URLã®å‡¦ç†
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            
            return text;
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showError(message) {
            const content = document.getElementById('translation-content');
            content.innerHTML = `
                <div class="error-message">
                    <div class="error-icon">âš ï¸</div>
                    <h3>ç¿»è¨³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p>${message}</p>
                    <div class="error-help">
                        <p><strong>è§£æ±ºæ–¹æ³•:</strong></p>
                        <ul>
                            <li>ç¿»è¨³ãƒ•ã‚¡ã‚¤ãƒ«ãŒ <code>research_papers/translations/</code> ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</li>
                            <li>ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„</li>
                            <li>HTTPã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard() {
            const content = document.getElementById('translation-content');
            const text = content.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                // æˆåŠŸæ™‚ã®é€šçŸ¥
                showNotification('ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
                showNotification('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            });
        }

        // é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç¿»è¨³ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            loadTranslation();
        });
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</body>
</html>