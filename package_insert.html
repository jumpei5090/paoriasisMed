<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添付文書 - PsoriasisMed</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #f4f4f9;
        }

        .package-insert-layout {
            display: flex;
            flex-direction: row;
            max-width: 1400px;
            margin: 40px auto;
            gap: 30px;
        }

        .toc-container {
            flex: 0 0 280px;
            position: sticky;
            top: 100px;
            height: calc(100vh - 120px);
            overflow-y: auto;
            order: 2;
        }

        .toc {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e5e5e7;
        }

        .toc h3 {
            margin-top: 0;
            font-size: 16px;
            color: #1d1d1f;
            font-weight: 600;
            border-bottom: 1px solid #e5e5e7;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .toc ul li {
            margin-bottom: 0;
        }

        .toc ul li a {
            text-decoration: none;
            color: #6e6e73;
            display: block;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            border-radius: 6px;
            border-left: 3px solid transparent;
        }

        .toc ul li a:hover {
            color: #007AFF;
            background-color: #f0f8ff;
            border-left-color: #007AFF;
        }
        
        .toc ul li a.active {
            color: #007AFF;
            background-color: #e3f2fd;
            font-weight: 500;
            border-left-color: #007AFF;
        }

        /* Custom scrollbar for vertical scrolling */
        .toc-container::-webkit-scrollbar {
            width: 6px;
        }

        .toc-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .toc-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .toc-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .package-insert-container {
            flex: 1;
            min-width: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 40px;
            order: 1;
        }

        .package-insert-header {
            text-align: center;
            border-bottom: 1px solid #e5e5e7;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .package-insert-header h1 {
            font-size: 28px;
            color: #1d1d1f;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .package-insert-header .drug-name {
            font-size: 20px;
            font-weight: 600;
            color: #007AFF;
        }

        .search-box {
            position: sticky;
            top: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            margin: -40px -40px 30px -40px;
            border-bottom: 1px solid #e5e5e7;
            z-index: 100;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .package-insert-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            line-height: 1.8;
            color: #333;
        }

        .package-insert-content h1, .package-insert-content h2, .package-insert-content h3, .package-insert-content h4 {
            font-weight: 600;
            margin-top: 2.5em;
            margin-bottom: 1em;
            color: #1d1d1f;
        }

        .package-insert-content h1 { font-size: 24px; border-bottom: 2px solid #007AFF; padding-bottom: 0.3em; }
        .package-insert-content h2 { font-size: 20px; border-bottom: 1px solid #e5e5e7; padding-bottom: 0.3em; }
        .package-insert-content h3 { font-size: 18px; }
        .package-insert-content h4 { font-size: 16px; }

        .package-insert-content p { margin: 0 0 1em 0; }
        .package-insert-content ul, .package-insert-content ol { padding-left: 25px; margin-bottom: 1em; }
        .package-insert-content li { margin-bottom: 0.5em; }

        .package-insert-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e5e7;
        }

        .package-insert-content th, .package-insert-content td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e5e7;
        }

        .package-insert-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .package-insert-content tbody tr:last-child th,
        .package-insert-content tbody tr:last-child td {
            border-bottom: none;
        }

        .package-insert-content tbody tr:hover {
            background-color: #f1f8ff;
        }

        .section-box {
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
            border-left: 5px solid;
        }

        .section-warning {
            background-color: #fffbe6;
            border-color: #ffc107;
        }
        .section-warning h1, .section-warning h2 { color: #856404; border-color: #ffeeba; }

        .section-contraindication {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .section-contraindication h1, .section-contraindication h2 { color: #721c24; border-color: #f5c6cb; }

        .highlight { background-color: #ffeb3b; }
        .loading, .error { text-align: center; padding: 50px; font-size: 18px; color: #666; }
        .error { background-color: #f8d7da; color: #721c24; border-radius: 8px; }

        @media (max-width: 1024px) {
            .package-insert-layout {
                flex-direction: column;
            }
            .toc-container {
                position: static;
                height: auto;
                max-height: 300px;
                margin-bottom: 20px;
                order: 1;
            }
            .package-insert-container {
                order: 2;
            }
        }
        
        @media (max-width: 768px) {
            .package-insert-container {
                padding: 20px;
            }
            .search-box {
                margin: -20px -20px 20px -20px;
            }
        }
        @media (max-width: 768px) {
            .package-insert-container { padding: 20px; }
            .search-box { margin: -20px -20px 20px -20px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">PsoriasisMed</div>
            <nav>
                <ul>
                    <li><a href="index.html#hero">ホーム</a></li>
                    <li><a href="index.html#categories">治療薬</a></li>
                    <li><a href="index.html#comparison">薬剤比較</a></li>
                    <li><a href="index.html#about">サイトについて</a></li>
                    <li><a href="index.html#contact">お問い合わせ</a></li>
                </ul>
            </nav>
            <div class="utility-nav">
                <a href="search.html" class="search-icon">検索</a>
                <a href="favorites.html" class="favorite-icon">お気に入り</a>
            </div>
        </div>
    </header>

    <main>
        <div class="package-insert-layout">
            <div class="toc-container">
                <nav class="toc" id="toc">
                    <h3>目次</h3>
                    <ul id="toc-list"></ul>
                </nav>
            </div>
            <div class="package-insert-container">
                <div class="package-insert-header">
                    <h1 id="drug-name">薬剤名</h1>
                    <p class="drug-name" id="document-type">添付文書</p>
                </div>
                <div class="search-box">
                    <input type="text" class="search-input" id="search-input" placeholder="文書内を検索...">
                </div>
                <div class="package-insert-content" id="package-insert-content">
                    <div class="loading">添付文書を読み込み中...</div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-columns">
                <div class="footer-logo">PsoriasisMed</div>
                <div class="footer-nav">
                    <h4>治療薬</h4>
                    <ul>
                        <li><a href="biological_agents.html">生物学的製剤</a></li>
                        <li><a href="oral_medications.html">内服薬</a></li>
                        <li><a href="topical_medications.html">外用薬</a></li>
                    </ul>
                </div>
                <div class="footer-nav">
                    <h4>情報</h4>
                    <ul>
                        <li><a href="search.html">薬剤検索</a></li>
                        <li><a href="index.html#comparison">比較機能</a></li>
                        <li><a href="how_to_use.html">使い方</a></li>
                        <li><a href="index.html#about">サイト情報</a></li>
                        <li><a href="privacy_policy.html">プライバシーポリシー</a></li>
                        <li><a href="terms_of_service.html">利用規約</a></li>
                    </ul>
                </div>
            </div>
            <div class="copyright">
                <p>© 2024 PsoriasisMed. All rights reserved.</p>
            </div>
            <div class="important-notice">
                <p>※本サイトの情報は医療従事者向けの参考情報です。実際の治療に関しては医師にご相談ください。</p>
                <p>⚠️ 重要な注意事項</p>
                <ul>
                    <li>医師判断の重要性: 本サイトの情報は参考資料であり、最終的な治療判断は医師が行ってください</li>
                    <li>最新情報の確認: 薬剤情報は定期的に更新されますが、最新の添付文書を必ずご確認ください</li>
                    <li>個別症例での判断: 患者様の個別の状態に応じた治療選択が必要です</li>
                    <li>エビデンスの解釈: 臨床試験結果は参考値であり、実臨床での効果を保証するものではありません</li>
                    <li>情報の責任: 本サイトの情報に基づく治療結果について、サイト運営者は責任を負いません</li>
                </ul>
            </div>
        </div>
    </footer>

    <script src="data.js"></script>
    <script src="biosimilar_data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const drugId = urlParams.get('drug');
            const type = urlParams.get('type') || 'tensho_text';
            const isBiosimilar = urlParams.get('is_biosimilar') === 'true';

            if (drugId) {
                loadPackageInsert(drugId, type, isBiosimilar);
            } else {
                showError('薬剤が指定されていません。');
            }

            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(searchInput.value), 300);
            });
        });

        function loadPackageInsert(drugId, type, isBiosimilar) {
            let drug;
            if (isBiosimilar) {
                for (const originator of biosimilarData) {
                    const found = originator.biosimilars.find(bs => bs.id === drugId);
                    if (found) {
                        drug = found;
                        break;
                    }
                }
            } else {
                drug = drugs.find(d => d.id === drugId);
            }

            if (!drug) {
                showError('指定された薬剤が見つかりません。');
                return;
            }

            document.getElementById('drug-name').textContent = drug.name;
            document.title = `${drug.name} 添付文書 - PsoriasisMed`;

            const directory = isBiosimilar ? 'attachments/biosimilars' : `attachments/${drugId}`;
            const filePath = isBiosimilar ? `${directory}/${drugId}.txt` : `attachments/${drugId}/${type}.txt`;


            fetch(filePath)
                .then(response => {
                    if (!response.ok) throw new Error(`添付文書が見つかりません (HTTP ${response.status})`);
                    return response.text();
                })
                .then(text => {
                    displayPackageInsert(text);
                    buildToc();
                    setupTocHighlighting();
                })
                .catch(error => {
                    console.error('Error loading package insert:', error);
                    showError(`添付文書の読み込みに失敗しました: ${error.message}`);
                });
        }

        function displayPackageInsert(text) {
            const contentEl = document.getElementById('package-insert-content');
            const html = convertTextToHtml(text);
            contentEl.innerHTML = html;
        }

        function convertTextToHtml(text) {
            const lines = text.split('\n');
            let html = '';
            let inTable = false;
            let inList = false;
            let inSection = ''; // To track special sections

            const closeSectionIfNeeded = () => {
                if (inSection) {
                    html += '</div>\n';
                    inSection = '';
                }
            };

            for (const line of lines) {
                if (line.trim() === '') {
                    if (inTable) { html += '</tbody></table>\n'; inTable = false; }
                    if (inList) { html += '</ul>\n'; inList = false; }
                    continue;
                }

                // Section handling
                if (line.includes('■警告')) {
                    closeSectionIfNeeded();
                    inSection = 'warning';
                    html += `<div class="section-box section-warning">\n`;
                } else if (line.includes('■禁忌')) {
                    closeSectionIfNeeded();
                    inSection = 'contraindication';
                    html += `<div class="section-box section-contraindication">\n`;
                } else if (line.startsWith('■')) {
                    closeSectionIfNeeded();
                }

                // Headers
                if (line.startsWith('# ')) { html += `<h1>${line.substring(2)}</h1>\n`; continue; }
                if (line.startsWith('## ') || line.startsWith('■')) { html += `<h2>${line.replace(/^##\s*|^■\s*/, '')}</h2>\n`; continue; }
                if (line.startsWith('### ')) { html += `<h3>${line.substring(4)}</h3>\n`; continue; }
                if (line.startsWith('#### ')) { html += `<h4>${line.substring(5)}</h4>\n`; continue; }

                // Tables
                if (line.includes('|')) {
                    if (!inTable) {
                        html += '<table class="data-table"><tbody>\n';
                        inTable = true;
                    }
                    const cells = line.split('|').slice(1, -1);
                    const tag = (line.includes('**') || line.match(/^:?-+:?$/) ) ? 'th' : 'td';
                    if (line.match(/^:?-+:?$/)) continue; // Skip separator line
                    html += '<tr>' + cells.map(c => `<${tag}>${c.trim().replace(/\*\*/g, '')}</${tag}>`).join('') + '</tr>\n';
                    continue;
                }
                if (inTable) { html += '</tbody></table>\n'; inTable = false; }
                
                // Lists
                if (line.match(/^\s*[-*]/) || line.match(/^\d+\./)) {
                    if (!inList) {
                        html += '<ul>\n';
                        inList = true;
                    }
                    html += `<li>${line.replace(/^\s*[-*]\s*|^\d+\.\s*/, '')}</li>\n`;
                    continue;
                }
                if (inList) { html += '</ul>\n'; inList = false; }

                // Paragraphs
                let p_line = line.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html += `<p>${p_line}</p>\n`;
            }
            
            closeSectionIfNeeded(); // Close any open section at the end
            if (inTable) html += '</tbody></table>\n';
            if (inList) html += '</ul>\n';

            return html;
        }
        
        function buildToc() {
            const content = document.getElementById('package-insert-content');
            const tocList = document.getElementById('toc-list');
            tocList.innerHTML = '';
            const headers = content.querySelectorAll('h1, h2');
            headers.forEach((h, i) => {
                const id = `header-${i}`;
                h.id = id;
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.textContent = h.textContent;
                if (h.tagName === 'H2') {
                    a.style.paddingLeft = '20px';
                }
                li.appendChild(a);
                tocList.appendChild(li);
            });
        }

        function setupTocHighlighting() {
            const tocLinks = document.querySelectorAll('#toc-list a');
            const headers = Array.from(document.querySelectorAll('.package-insert-content h1, .package-insert-content h2'));

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const link = document.querySelector(`#toc-list a[href="#${id}"]`);
                    if (entry.isIntersecting && link) {
                        tocLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    }
                });
            }, { rootMargin: "0px 0px -80% 0px" });

            headers.forEach(header => observer.observe(header));
        }

        let originalContent = '';
        function performSearch(query) {
            const contentEl = document.getElementById('package-insert-content');
            if (originalContent === '') originalContent = contentEl.innerHTML;

            // Restore original content
            contentEl.innerHTML = originalContent;

            if (!query || query.length < 2) return;

            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            const walker = document.createTreeWalker(contentEl, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodes = [];
            while(node = walker.nextNode()) {
                if(node.textContent.match(regex)) {
                    textNodes.push(node);
                }
            }

            textNodes.forEach(node => {
                const span = document.createElement('span');
                span.innerHTML = node.textContent.replace(regex, `<mark class="highlight">$1</mark>`);
                node.parentNode.replaceChild(span, node);
            });
        }

        function showError(message) {
            document.getElementById('package-insert-content').innerHTML = `<div class="error">${message}</div>`;
        }
    </script>
</body>
</html>